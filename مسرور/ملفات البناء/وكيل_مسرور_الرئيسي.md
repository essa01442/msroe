# دليل بناء وكيل مسرور الرئيسي (The Orchestrator)

هذا الدليل يوضح المكونات الأساسية وخطوات بناء الوكيل "مسرور"، الذي يمثل العقل المدبر والمنسق المركزي في المنظومة.

---

### **الهدف من الوكيل**

وكيل مسرور هو المسؤول عن استقبال المهام من المستخدمين، تحليلها، تفكيكها إلى خطوات فرعية، وتوزيعها على الوكلاء المتخصصين لتنفيذها. كما يقوم بتجميع النتائج وتقديمها للمستخدم بصيغة نهائية متكاملة.

---

### **المكونات الأساسية (العُقد - Nodes)**

يتكون الوكيل من مجموعة من العقد المترابطة التي تشكل تدفق العمل الرئيسي:

1.  **عقدة الاستقبال (Ingestion Node):**
    *   **الوظيفة:** استقبال الطلبات الأولية من المستخدمين عبر واجهات مختلفة (API, Telegram Bot, Web UI).
    *   **البيانات:** تستقبل نص الطلب الخام، هوية المستخدم، وأي ملفات مرفقة.

2.  **عقدة التحليل والتخطيط (Planner Node):**
    *   **الوظيفة:** هي العقل الفعلي للوكيل. تستخدم نموذج لغة متقدم (LLM) لتحليل الطلب وتحديد الهدف الرئيسي. تقوم بتفكيك الهدف إلى خطة عمل متسلسلة (Chain-of-Thought).
    *   **البيانات:** تُصدر "خطة تنفيذ" تحتوي على قائمة بالمهام، والوكلاء المقترحين لكل مهمة.

3.  **عقدة التوجيه (Router Node):**
    *   **الوظيفة:** بناءً على خطة التنفيذ، تقوم هذه العقدة بتوجيه كل مهمة فرعية إلى الوكيل المتخصص المناسب.
    *   **البيانات:** تتعامل مع "كائن المهمة" (Task Object) الذي يحتوي على تفاصيل المهمة والبيانات اللازمة لتنفيذها.

4.  **عقدة التنفيذ وإدارة الوكلاء (Agent Manager Node):**
    *   **الوظيفة:** تدير دورة حياة الوكلاء الفرعيين. تستدعي الوكلاء (مثل وكيل المصادقة، وكيل التحليل، إلخ)، تمرر لهم البيانات، وتنتظر النتائج.
    *   **البيانات:** تتلقى "نتائج المهمة" (Task Result) من كل وكيل.

5.  **عقدة الذاكرة والسياق (Memory & Context Node):**
    *   **الوظيفة:** تخزن جميع التفاعلات، الخطط، والنتائج في قاعدة بيانات متجهة (Vector DB) أو قاعدة بيانات منظمة. هذا يسمح للوكيل بتذكر السياق في المحادثات الطويلة والتعلم من التفاعلات السابقة.
    *   **البيانات:** تدير "سجل المحادثة" و"قاعدة المعرفة".

6.  **عقدة التجميع والتصدير (Aggregation & Output Node):**
    *   **الوظيفة:** تجمع النتائج من جميع المهام الفرعية، تصيغها في استجابة نهائية متماسكة، وتقدمها للمستخدم عبر نفس الواجهة التي بدأ منها.

---

### **الإضافات (Plugins)**

وكيل مسرور يعتمد على مجموعة من الوكلاء المتخصصين كإضافات (Plugins) لتنفيذ مهام محددة:

*   `security_agent`: يستخدم لتنفيذ عمليات المصادقة والتوقيع الرقمي (يستدعي وكيل `Google_Auth` ووكيل `Digital_Signature`).
*   `data_analysis_agent`: يستخدم لتحليل البيانات، إنشاء الرسوم البيانية، واستخلاص الإحصائيات.
*   `code_interpreter_agent`: لتنفيذ أكواد Python في بيئة معزولة وآمنة.
*   `communication_agent`: لإرسال الإشعارات والتقارير عبر البريد الإلكتروني أو تليجرام.
*   `web_search_agent`: للبحث عن معلومات آنية على الإنترنت.

---

### **هيكل البيانات المقترح**

```json
// مثال على "كائن المهمة" - Task Object
{
  "task_id": "t-12345",
  "user_id": "user001",
  "main_goal": "حلل بيانات المبيعات للربع الأخير وأرسل تقريراً للمدير.",
  "plan": [
    {
      "step": 1,
      "description": "استخراج بيانات المبيعات من قاعدة البيانات.",
      "agent": "data_analysis_agent",
      "status": "pending",
      "input": {"query": "SELECT * FROM sales WHERE quarter='Q4'"}
    },
    {
      "step": 2,
      "description": "إنشاء رسم بياني يوضح نمو المبيعات.",
      "agent": "data_analysis_agent",
      "status": "pending",
      "input": {"data": "output_from_step_1"}
    },
    {
      "step": 3,
      "description": "إرسال التقرير عبر البريد الإلكتروني.",
      "agent": "communication_agent",
      "status": "pending",
      "input": {
        "recipient": "manager@example.com",
        "subject": "تقرير المبيعات للربع الأخير",
        "body": "output_from_step_2"
      }
    }
  ]
}
```

---

### **خطوات التهيئة (`__init__`)**

عند بناء الوكيل، يجب اتباع الخطوات التالية:

1.  **تحميل الإعدادات:** قراءة ملفات التكوين (API Keys, DB paths).
2.  **تهيئة الذاكرة:** الاتصال بقاعدة بيانات الذاكرة (Vector DB).
3.  **تسجيل الإضافات:** تحميل جميع الوكلاء الفرعيين المتاحين وتعريف قدراتهم للوكيل الرئيسي.
4.  **بدء خدمات الواجهات:** تشغيل المستمعين (Listeners) على واجهات برمجة التطبيقات أو البوتات.

بهذه المعمارية، يصبح "مسرور" نظاماً مرناً وقابلاً للتوسعة، قادراً على تنسيق مهام معقدة بكفاءة.
